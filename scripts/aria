#!/bin/bash
# ARIA CLI - Token Optimizer Command Interface
# Gemini-style reporting with model routing

ARIA_DIR="$HOME/.claude"
ARIA_SCRIPTS="$ARIA_DIR/scripts"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
WHITE='\033[1;37m'
DIM='\033[2m'
RESET='\033[0m'

show_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ___    ____  _____    ___
   /   |  / __ \/  _/   /   |
  / /| | / /_/ // /    / /| |
 / ___ |/ _, _// /    / ___ |
/_/  |_/_/ |_/___/   /_/  |_|

Token Optimizer v2.0
EOF
    echo -e "${RESET}"
}

show_help() {
    echo ""
    echo -e "${WHITE}ARIA Token Optimizer${RESET}"
    echo ""
    echo "Usage: aria <command> [options]"
    echo ""
    echo -e "${WHITE}Performance:${RESET}"
    echo "  score, s          Show efficiency score (Gemini-style)"
    echo "  compact, c        Show compact one-line score"
    echo "  status, st        Show raw session state"
    echo "  reset, r          Reset session counters"
    echo ""
    echo -e "${WHITE}Conversation Memory:${RESET}"
    echo "  session, ss       Show current session info"
    echo "  session new       Create new conversation session"
    echo "  session show      Show conversation history"
    echo "  session clear     Clear conversation history"
    echo ""
    echo -e "${WHITE}Agent Context (shared memory):${RESET}"
    echo "  context, ctx      Show agent context log"
    echo "  context add <agent> <summary>  Add entry"
    echo "  context clear     Clear agent context"
    echo ""
    echo -e "${WHITE}Blocking:${RESET}"
    echo "  override, o       Bypass blocking for 1 hour"
    echo "  override clear    Clear the override"
    echo ""
    echo -e "${WHITE}Model Routing:${RESET}"
    echo "  route <type> <prompt>   Route to optimal model"
    echo "  models, m               Show model routing table"
    echo "  gemini <prompt>         Direct Gemini query (FREE)"
    echo ""
    echo -e "${WHITE}Task Types for Routing:${RESET}"
    echo "  instant  - Fast tasks (codex-mini, Haiku replacement)"
    echo "  general  - General tasks (gpt-5.1)"
    echo "  code     - Code generation (gpt-5.1-codex)"
    echo "  complex  - Hard problems (codex-max)"
    echo "  max      - Maximum reasoning depth (codex-max extra_high)"
    echo "  context  - Large context (gemini FREE)"
    echo ""
    echo -e "${WHITE}Examples:${RESET}"
    echo "  aria score                          # Show session summary"
    echo "  aria session new                    # Start fresh conversation"
    echo "  aria route instant 'quick question' # Fast response"
    echo "  aria route code 'implement auth'    # Code generation"
    echo "  aria session show                   # View conversation"
    echo ""
}

case "${1:-help}" in
    score|s)
        source "$ARIA_SCRIPTS/aria-score.sh" 2>/dev/null
        aria_show_summary
        ;;

    compact|c)
        source "$ARIA_SCRIPTS/aria-score.sh" 2>/dev/null
        aria_show_compact
        ;;

    status|st)
        if [[ -f "$ARIA_DIR/.aria-state" ]]; then
            jq . "$ARIA_DIR/.aria-state"
        else
            echo "No session state found"
        fi
        ;;

    reset|r)
        source "$ARIA_SCRIPTS/aria-state.sh" 2>/dev/null
        aria_init
        echo -e "${GREEN}Session reset${RESET}"
        ;;

    override|o)
        source "$ARIA_SCRIPTS/aria-block.sh" 2>/dev/null
        case "$2" in
            clear|c)
                aria_clear_override
                ;;
            status|s)
                if aria_override_active; then
                    echo "Override: ACTIVE"
                else
                    echo "Override: inactive"
                fi
                ;;
            *)
                aria_set_override
                ;;
        esac
        ;;

    route)
        shift
        source "$ARIA_SCRIPTS/aria-route.sh" 2>/dev/null
        aria_route "$@"
        ;;

    models|m)
        source "$ARIA_SCRIPTS/aria-route.sh" 2>/dev/null
        aria_show_models
        ;;

    gemini|g)
        shift
        source "$ARIA_SCRIPTS/aria-route.sh" 2>/dev/null
        aria_gemini "$@"
        ;;

    session|ss)
        source "$ARIA_SCRIPTS/aria-session.sh" 2>/dev/null
        case "$2" in
            new|n)
                aria_session_init
                echo -e "${GREEN}New session created${RESET}"
                ;;
            show|s)
                aria_session_get_history 20
                ;;
            clear|c)
                aria_session_clear
                echo -e "${GREEN}Session cleared${RESET}"
                ;;
            list|l)
                aria_session_list
                ;;
            off)
                export ARIA_SESSION_ENABLED=0
                echo -e "${YELLOW}Session memory disabled${RESET}"
                ;;
            on)
                export ARIA_SESSION_ENABLED=1
                echo -e "${GREEN}Session memory enabled${RESET}"
                ;;
            *)
                echo -e "${WHITE}Current Session:${RESET} $(aria_session_current 2>/dev/null || echo 'none')"
                echo -e "${WHITE}Session Dir:${RESET} ~/.claude/cache/sessions/"
                echo ""
                echo "Use 'aria session show' to view conversation history"
                ;;
        esac
        ;;

    context|ctx)
        shift
        "$ARIA_SCRIPTS/aria-agent-context.sh" "$@"
        ;;

    banner|b)
        show_banner
        ;;

    help|h|--help|-h)
        show_banner
        show_help
        ;;

    *)
        # Check if it's a task type for routing
        if [[ "$1" =~ ^(quick|code|reason|fast|refactor|math|context)$ ]]; then
            source "$ARIA_SCRIPTS/aria-route.sh" 2>/dev/null
            aria_route "$@"
        else
            show_help
        fi
        ;;
esac
